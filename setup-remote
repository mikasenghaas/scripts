#!/bin/bash

set -e

# Colors for output
GREEN='\033[0;32m'
NC='\033[0m' # No Color

log() {
  echo -e "${GREEN}[INFO]${NC} $1"
}

# Install sudo if not present
log "Updating package index..."
if ! command -v sudo &>/dev/null; then
  apt update && apt install -y sudo
fi

log "Installing packages..."
sudo apt update && sudo apt install -y tmux vim git htop nvtop exa bat iputils-ping iperf

# Install 1Password CLI
if ! command -v op &>/dev/null; then
  log "Installing 1Password CLI..."
  curl -sS https://downloads.1password.com/linux/keys/1password.asc |
    sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg &&
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" |
    sudo tee /etc/apt/sources.list.d/1password.list &&
    sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/ &&
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol |
    sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol &&
    sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22 &&
    curl -sS https://downloads.1password.com/linux/keys/1password.asc |
    sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg &&
    sudo apt update && sudo apt install 1password-cli
fi

if ! command -v uv &>/dev/null; then
  log "Installing uv..."
  curl -LsSf https://astral.sh/uv/install.sh | sh
  source $HOME/.local/bin/env
fi

if ! command -v hf &>/dev/null; then
  log "Installing HuggingFace CLI..."
  uv tool install huggingface-hub[cli]
fi

if ! command -v wandb &>/dev/null; then
  log "Installing Wandb CLI..."
  uv tool install wandb
fi

if ! command -v prime &>/dev/null; then
  log "Installing Prime CLI..."
  uv tool install prime
fi

if ! command -v gh &>/dev/null; then
  log "Installing GitHub CLI..."
  sudo apt update && sudo apt install gh -y
fi

log "Installing starship..."
curl -sS https://starship.rs/install.sh | sudo sh -s -- -y

log "Updating .bashrc..."
cat >$HOME/.bashrc <<'EOL'
# Guard
[[ $- != *i* ]] && return

# Aliases
alias ls="exa"
alias ll="exa -lal"
alias cat="bat --style=plain"

# Make bat available on ubuntu
if [ ! -e ~/.local/bin/bat ]; then
    ln -s /usr/bin/batcat ~/.local/bin/bat
fi

# Add ~/.local/bin to path (for uv)
export PATH="$HOME/.local/bin:$PATH"

# Access 1Password secrets temporarily
export OP_SERVICE_ACCOUNT_TOKEN=

# Initialize starship
eval "$(starship init bash)"
EOL

log "Updating .env..."
cat >$HOME/.env <<'EOL'
GH_TOKEN=
HF_TOKEN=
OPENAI_API_KEY=
PRIME_API_KEY=
PRIME_TEAM_ID=
WANDB_API_KEY=
EOL

log "Installation completed! Please paste your 1Password service account token into '~/.bashrc' and then restart your shell with 'source ~/.bashrc'"
