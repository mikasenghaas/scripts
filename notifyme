#!/bin/bash
# discord webhook notifier
set -u

webhook_url="${DISCORD_WEBHOOK_URL:-}"

format_elapsed() {
  local total="${1:-0}"
  if ((total >= 86400)); then
    echo "$((total / 86400))d"
  elif ((total >= 3600)); then
    echo "$((total / 3600))h"
  elif ((total >= 60)); then
    echo "$((total / 60))m"
  else
    echo "${total}s"
  fi
}

send_notification() {
  local cmd="${1:-job}" status="${2:-0}" elapsed="${3:-}"
  local host=$(hostname -s)
  local title suffix=""

  if [[ -n "$elapsed" ]]; then
    suffix=" in $(format_elapsed "$elapsed")"
  fi

  if [ "$status" -eq 0 ]; then
    title="✅ Job succeeded on $host${suffix}"
  else
    title="❌ Job failed on $host${suffix}"
  fi

  msg=$(
    cat <<EOF
$title
\`\`\`bash
$cmd
\`\`\`
EOF
  )

  if [ -n "$webhook_url" ]; then
    curl -fsS -X POST -F "content=$msg" "$webhook_url" >/dev/null || true
  fi
}

main() {
  if [ -z "$webhook_url" ]; then
    echo "Set DISCORD_WEBHOOK_URL environment variable" >&2
    exit 2
  fi

  start=$(date +%s)
  "$@"
  st=$?
  end=$(date +%s)
  elapsed=$((end - start))
  send_notification "$*" "$st" "$elapsed"
  exit $st
}

main "$@"
